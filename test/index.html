<html>
  <head>
    <script src="../lib/require.js"></script>
    <script src="test-config.js"></script>
    <script src="lib/gif.js"></script>
    <script src="../lib/polymer.min.js"></script>
    <style>
      html, body {
        padding: 0;
        margin: 0;
      }
      .no-user-select {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
      }
      .disabled {
        color: #ccc;
      }
      #container {
        position: relative;
        border: 1px solid #000;
        width: 300px;
        height: 450px;
        padding: 20px;
        background: rgb(76,76,76); /* Old browsers */
        background: -moz-linear-gradient(top,  rgba(76,76,76,1) 0%, rgba(89,89,89,1) 12%, rgba(102,102,102,1) 25%, rgba(71,71,71,1) 39%, rgba(44,44,44,1) 50%, rgba(0,0,0,1) 51%, rgba(17,17,17,1) 60%, rgba(43,43,43,1) 76%, rgba(28,28,28,1) 91%, rgba(19,19,19,1) 100%); /* FF3.6+ */
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(76,76,76,1)), color-stop(12%,rgba(89,89,89,1)), color-stop(25%,rgba(102,102,102,1)), color-stop(39%,rgba(71,71,71,1)), color-stop(50%,rgba(44,44,44,1)), color-stop(51%,rgba(0,0,0,1)), color-stop(60%,rgba(17,17,17,1)), color-stop(76%,rgba(43,43,43,1)), color-stop(91%,rgba(28,28,28,1)), color-stop(100%,rgba(19,19,19,1))); /* Chrome,Safari4+ */
        background: -webkit-linear-gradient(top,  rgba(76,76,76,1) 0%,rgba(89,89,89,1) 12%,rgba(102,102,102,1) 25%,rgba(71,71,71,1) 39%,rgba(44,44,44,1) 50%,rgba(0,0,0,1) 51%,rgba(17,17,17,1) 60%,rgba(43,43,43,1) 76%,rgba(28,28,28,1) 91%,rgba(19,19,19,1) 100%); /* Chrome10+,Safari5.1+ */
        background: -o-linear-gradient(top,  rgba(76,76,76,1) 0%,rgba(89,89,89,1) 12%,rgba(102,102,102,1) 25%,rgba(71,71,71,1) 39%,rgba(44,44,44,1) 50%,rgba(0,0,0,1) 51%,rgba(17,17,17,1) 60%,rgba(43,43,43,1) 76%,rgba(28,28,28,1) 91%,rgba(19,19,19,1) 100%); /* Opera 11.10+ */
        background: -ms-linear-gradient(top,  rgba(76,76,76,1) 0%,rgba(89,89,89,1) 12%,rgba(102,102,102,1) 25%,rgba(71,71,71,1) 39%,rgba(44,44,44,1) 50%,rgba(0,0,0,1) 51%,rgba(17,17,17,1) 60%,rgba(43,43,43,1) 76%,rgba(28,28,28,1) 91%,rgba(19,19,19,1) 100%); /* IE10+ */
        background: linear-gradient(to bottom,  rgba(76,76,76,1) 0%,rgba(89,89,89,1) 12%,rgba(102,102,102,1) 25%,rgba(71,71,71,1) 39%,rgba(44,44,44,1) 50%,rgba(0,0,0,1) 51%,rgba(17,17,17,1) 60%,rgba(43,43,43,1) 76%,rgba(28,28,28,1) 91%,rgba(19,19,19,1) 100%); /* W3C */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#4c4c4c', endColorstr='#131313',GradientType=0 ); /* IE6-9 */
        overflow-y: scroll;
      }
      #shutter {
        margin: 0 auto;
        width: 250px;
        height: 200px;
        background-color: rgba(100, 100, 100, 0.5);
      }
      #shutter video {
        width: 100%;
        height: 100%;
      }
      #shutter div[data-shutter-image-container] {
        width: 100%;
        height: 100%;
      }
      #shutter div[data-shutter-image-container] img {
        width: 100%;
      }
      #buttons {
        text-align: center;
      }
      button {
        display: inline-block;
        margin: 10px auto;
        height: 30px;
        width: 90px;
      }
      #roll {
        margin: 10px auto;
        width: 305px;
        background-color: rgb(96,108,136);
        background-image: url('assets/film-strip.png');
        background-size: auto 70px;
        min-height: 70px;
      }
      #roll canvas {
        display: inline;
        width: 63px;
        margin: 11.5px 6.5px;
      }
    </style>
  </head>
  <body>
    <div id="container" class="no-user-select">
      <div id="shutter" name="Lense"><video></video><div data-shutter-image-container="true"></div></div>
      <div id="buttons">
        <button id="button1" name="Shutter Button" class="disabled">Take Picture</button>
        <button id="button2" name="Gif Button" class="disabled">Create Gif</button>
        <button id="button3" name="Clear Button" class="disabled">Clear</button>
      </div>
      <div id="roll" name="Image Library"></div>
    </div>
    <script>
      testRequireContext(['appbuilder'], function () {
        var shutterElement = document.querySelector('#shutter');
        var button1Element = document.querySelector('#button1');
        var button2Element = document.querySelector('#button2');
        var button3Element = document.querySelector('#button3');
        var videoElement = shutterElement.querySelector('video');
        var rollElement = document.querySelector('#roll');

        var __getUserMedia = navigator.getUserMedia ||
                             navigator.webkitGetUserMedia ||
                             navigator.mozGetUserMedia ||
                             navigator.msGetUserMedia;

        __getUserMedia.call(navigator, {video: true, audio: false},
          function (stream) {
            if (navigator.mozGetUserMedia) {
              videoElement.mozSrcObject = stream;
            } else {
              var vendorURL = window.URL || window.webkitURL;
              videoElement.src = vendorURL.createObjectURL(stream);
            }
            videoElement.play();
          },
          function (err) {
            console.err('Couldn\'t prepare camera.');
          });

        videoElement.addEventListener('canplay', function (e) {
          shutterElement._appbuilder.sendOutput('isReady');
        }, false);

        function initButtonElement (buttonElement) {
          appbuilder.initElement(buttonElement, {
            inputs: {
              click: {
                type: 'event',
                description: 'trigger {{name}}'
              },
              enable: {
                type: 'event',
                description: 'enable {{name}}'
              },
              disable: {
                type: 'event',
                description: 'disable {{name}}'
              }
            },
            outputs: {
              click: {
                type: 'event',
                description: '{{name}} is clicked'
              }
            }
          });
        
          var disabled = true;

          buttonElement._appbuilder.onInput('enable', function () {
            console.log('enable!!');
            disabled = false;
            buttonElement.classList.remove('disabled');
          });

          buttonElement._appbuilder.onInput('disable', function () {
            disabled = true;
            buttonElement.classList.add('disabled');
          });

          buttonElement.addEventListener('click', function (e) {
            if (!disabled) {
              buttonElement._appbuilder.sendOutput('click');
            }
          }, false);
        }

        initButtonElement(button1Element);
        initButtonElement(button2Element);
        initButtonElement(button3Element);

        appbuilder.initElement(shutterElement, {
          inputs: {
            takePicture: {
              type: 'event',
              description: 'take a picture'
            },
            showImage: {
              type: 'image',
              description: 'display an image'
            },
            clearImage: {
              type: 'image',
              description: 'clear an image if one is being displayed'
            }
          },
          outputs: {
            isReady: {
              type: 'event',
              description: '{{name}} is ready'
            },
            pictureTaken: {
              type: 'image',
              description: '{{name}} takes a picture'
            }
          }
        });

        appbuilder.initElement(rollElement, {
          inputs: {
            insertPicture: {
              type: 'image',
              description: 'store the image in {{name}}'
            },
            createGif: {
              type: 'event',
              description: 'create a GIF from the images in {{name}}'
            },
            clear: {
              type: 'event',
              description: 'clear {{name}}'
            }
          },
          outputs: {
            gifCreated: {
              type: 'image',
              description: 'a GIF was created'
            },
            hasPictures: {
              type: 'event',
              description: 'contains pictures'
            },
            isEmpty: {
              type: 'event',
              description: 'is empty'
            }
          }
        });

        shutterElement._appbuilder.events.on('connect', function (e) {
          console.log(e);
        });

        shutterElement._appbuilder.onInput('takePicture', function(data) {
          var canvas = document.createElement('canvas');
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
          canvas.getContext('2d').drawImage(videoElement, 0, 0, canvas.width, canvas.height);
          shutterElement._appbuilder.sendOutput('pictureTaken', canvas);
        });

        rollElement._appbuilder.onInput('insertPicture', function(canvas) {
          if (rollElement.firstChild) {
            rollElement.insertBefore(canvas, rollElement.firstChild);
          } else {
            rollElement.appendChild(canvas);
          }

          var canvasElements = rollElement.querySelectorAll('canvas');
          if (canvasElements.length > 0) {
            rollElement._appbuilder.sendOutput('hasPictures', canvasElements);
          }
        });

        rollElement._appbuilder.onInput('createGif', function () {
          var gif = new GIF({
            workers: 2,
            workerScript: 'lib/gif.worker.js',
            quality: 10
          });

          var canvasElements = Array.prototype.slice.call(rollElement.querySelectorAll('canvas')).reverse();
          canvasElements.forEach(function (canvas) {
            gif.addFrame(canvas, {delay: 100});
          });

          gif.on('finished', function(blob) {
            var img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            rollElement._appbuilder.sendOutput('gifCreated', img);
          });

          gif.render();          
        });

        rollElement._appbuilder.onInput('clear', function () {
          while(rollElement.firstChild) {
            rollElement.removeChild(rollElement.firstChild);
          }
          rollElement._appbuilder.sendOutput('isEmpty');
        });

        shutterElement._appbuilder.onInput('showImage', function (img) {
          videoElement.hidden = true;
          var shutterImageContainer = shutterElement.querySelector('div[data-shutter-image-container]');
          shutterImageContainer.appendChild(img);
        });

        shutterElement._appbuilder.onInput('clearImage', function (img) {
          videoElement.hidden = false;
          var shutterImageContainer = shutterElement.querySelector('div[data-shutter-image-container]');
          while(shutterImageContainer.firstChild) {
            shutterImageContainer.removeChild(shutterImageContainer.firstChild);
          }
        });

        if (window.location.search.indexOf('nographinit') === -1) {
          button1Element._appbuilder.connectOutput('click', shutterElement._appbuilder, 'takePicture');
          button2Element._appbuilder.connectOutput('click', rollElement._appbuilder, 'createGif');
          button2Element._appbuilder.connectOutput('click', button1Element._appbuilder, 'disable');
          button2Element._appbuilder.connectOutput('click', button2Element._appbuilder, 'disable');
          button2Element._appbuilder.connectOutput('click', button3Element._appbuilder, 'disable');
          button3Element._appbuilder.connectOutput('click', rollElement._appbuilder, 'clear');
          button3Element._appbuilder.connectOutput('click', shutterElement._appbuilder, 'clearImage');
          button3Element._appbuilder.connectOutput('click', button1Element._appbuilder, 'enable');
          rollElement._appbuilder.connectOutput('hasPictures', button2Element._appbuilder, 'enable');
          rollElement._appbuilder.connectOutput('hasPictures', button3Element._appbuilder, 'enable');
          rollElement._appbuilder.connectOutput('isEmpty', button2Element._appbuilder, 'disable');
          rollElement._appbuilder.connectOutput('isEmpty', button3Element._appbuilder, 'disable');
          shutterElement._appbuilder.connectOutput('pictureTaken', rollElement._appbuilder, 'insertPicture');
          rollElement._appbuilder.connectOutput('gifCreated', shutterElement._appbuilder, 'showImage');
          rollElement._appbuilder.connectOutput('gifCreated', button3Element._appbuilder, 'enable');
          shutterElement._appbuilder.connectOutput('isReady', button1Element._appbuilder, 'enable');
        }
      });
    </script>
  </body>
</html>