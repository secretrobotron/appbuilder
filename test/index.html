<html>
  <head>
    <script src="../lib/require.js"></script>
    <script src="test-config.js"></script>
    <style>
      #container {
        position: relative;
        border: 1px solid #000;
        width: 300px;
        height: 450px;
        padding: 20px;
        background: rgb(76,76,76); /* Old browsers */
        background: -moz-linear-gradient(top,  rgba(76,76,76,1) 0%, rgba(89,89,89,1) 12%, rgba(102,102,102,1) 25%, rgba(71,71,71,1) 39%, rgba(44,44,44,1) 50%, rgba(0,0,0,1) 51%, rgba(17,17,17,1) 60%, rgba(43,43,43,1) 76%, rgba(28,28,28,1) 91%, rgba(19,19,19,1) 100%); /* FF3.6+ */
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(76,76,76,1)), color-stop(12%,rgba(89,89,89,1)), color-stop(25%,rgba(102,102,102,1)), color-stop(39%,rgba(71,71,71,1)), color-stop(50%,rgba(44,44,44,1)), color-stop(51%,rgba(0,0,0,1)), color-stop(60%,rgba(17,17,17,1)), color-stop(76%,rgba(43,43,43,1)), color-stop(91%,rgba(28,28,28,1)), color-stop(100%,rgba(19,19,19,1))); /* Chrome,Safari4+ */
        background: -webkit-linear-gradient(top,  rgba(76,76,76,1) 0%,rgba(89,89,89,1) 12%,rgba(102,102,102,1) 25%,rgba(71,71,71,1) 39%,rgba(44,44,44,1) 50%,rgba(0,0,0,1) 51%,rgba(17,17,17,1) 60%,rgba(43,43,43,1) 76%,rgba(28,28,28,1) 91%,rgba(19,19,19,1) 100%); /* Chrome10+,Safari5.1+ */
        background: -o-linear-gradient(top,  rgba(76,76,76,1) 0%,rgba(89,89,89,1) 12%,rgba(102,102,102,1) 25%,rgba(71,71,71,1) 39%,rgba(44,44,44,1) 50%,rgba(0,0,0,1) 51%,rgba(17,17,17,1) 60%,rgba(43,43,43,1) 76%,rgba(28,28,28,1) 91%,rgba(19,19,19,1) 100%); /* Opera 11.10+ */
        background: -ms-linear-gradient(top,  rgba(76,76,76,1) 0%,rgba(89,89,89,1) 12%,rgba(102,102,102,1) 25%,rgba(71,71,71,1) 39%,rgba(44,44,44,1) 50%,rgba(0,0,0,1) 51%,rgba(17,17,17,1) 60%,rgba(43,43,43,1) 76%,rgba(28,28,28,1) 91%,rgba(19,19,19,1) 100%); /* IE10+ */
        background: linear-gradient(to bottom,  rgba(76,76,76,1) 0%,rgba(89,89,89,1) 12%,rgba(102,102,102,1) 25%,rgba(71,71,71,1) 39%,rgba(44,44,44,1) 50%,rgba(0,0,0,1) 51%,rgba(17,17,17,1) 60%,rgba(43,43,43,1) 76%,rgba(28,28,28,1) 91%,rgba(19,19,19,1) 100%); /* W3C */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#4c4c4c', endColorstr='#131313',GradientType=0 ); /* IE6-9 */
        overflow-y: scroll;
      }
      #shutter {
        margin: 0 auto;
        width: 250px;
        height: 200px;
        background-color: rgba(100, 100, 100, 0.5);
      }
      #shutter video {
        width: 100%;
        height: 100%;
      }
      #button {
        display: block;
        margin: 20px auto;
        height: 30px;
        width: 200px;
      }
      #roll {
        margin: 10px 10px;
      }
      #roll canvas {
        display: inline;
        width: 31%;
        margin: 1%;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="shutter"><video></video></div>
      <button id="button" disabled>Take Picture</button>
      <div id="roll"></div>
    </div>
    <script>
      testRequireContext(['appbuilder'], function () {
        var shutterElement = document.querySelector('#shutter');
        var buttonElement = document.querySelector('#button');
        var videoElement = shutterElement.querySelector('video');
        var rollElement = document.querySelector('#roll');

        var __getUserMedia = navigator.getUserMedia ||
                             navigator.webkitGetUserMedia ||
                             navigator.mozGetUserMedia ||
                             navigator.msGetUserMedia;

        __getUserMedia.call(navigator, {video: true, audio: false},
          function (stream) {
            if (navigator.mozGetUserMedia) {
              videoElement.mozSrcObject = stream;
            } else {
              var vendorURL = window.URL || window.webkitURL;
              videoElement.src = vendorURL.createObjectURL(stream);
            }
            videoElement.play();            
          },
          function (err) {
            console.err('Couldn\'t prepare camera.');
          });

        videoElement.addEventListener('canplay', function (e) {
          buttonElement.disabled = false;
        }, false);

        appbuilder.initElement(shutterElement, {
          inputs: {
            takePicture: {
              type: 'event',
              description: 'take a picture'
            }
          },
          outputs: {
            pictureTaken: {
              type: 'image',
              description: 'takes a picture'
            }
          }
        });

        appbuilder.initElement(buttonElement, {
          inputs: {
            click: {
              type: 'event',
              description: 'trigger the button'
            }
          },
          outputs: {
            click: {
              type: 'event',
              description: 'is clicked'
            }
          }
        });

        appbuilder.initElement(rollElement, {
          inputs: {
            insertPicture: {
              type: 'image',
              description: 'store a picture in the roll'
            }
          },
          outputs: {

          }
        });

        buttonElement.addEventListener('click', function (e) {
          buttonElement._appbuilder.sendOutput('click');
        }, false);

        shutterElement._appbuilder.onInput('takePicture', function(data) {
          var canvas = document.createElement('canvas');
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
          canvas.getContext('2d').drawImage(videoElement, 0, 0, canvas.width, canvas.height);
          shutterElement._appbuilder.sendOutput('pictureTaken', canvas);
        });

        rollElement._appbuilder.onInput('insertPicture', function(canvas) {
          if (rollElement.firstChild) {
            rollElement.insertBefore(canvas, rollElement.firstChild);
          } else {
            rollElement.appendChild(canvas);
          }
        });

        buttonElement._appbuilder.connectOutput('click', shutterElement._appbuilder, 'takePicture');
        shutterElement._appbuilder.connectOutput('pictureTaken', rollElement._appbuilder, 'insertPicture');
      });
    </script>
  </body>
</html>